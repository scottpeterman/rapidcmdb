{% extends "base.html" %}

{% block title %}Pipeline Management - {{ app_name }}{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{{ url_for('dashboard.index') }}">Dashboard</a></li>
<li class="breadcrumb-item active">Pipeline Management</li>
{% endblock %}

{% block extra_css %}
<style>
    /* Enhanced Terminal Styling - Textarea Version */
    .terminal {
        background-color: #1e1e1e;
        color: #d4d4d4;
        font-family: 'Courier New', Consolas, 'Liberation Mono', Monaco, 'Lucida Console', monospace;
        font-size: 13px;
        line-height: 1.4;
        padding: 12px;
        border-radius: 6px;
        height: 400px !important;
        max-height: 400px !important;
        min-height: 300px;
        width: 100%;
        border: 1px solid #333;
        box-shadow: inset 0 2px 4px rgba(0,0,0,0.2);
        resize: none;
        outline: none;
        overflow-y: auto;
        overflow-x: hidden;
        white-space: pre-wrap;
        word-wrap: break-word;
        box-sizing: border-box;
    }

    .terminal:focus {
        border-color: #555;
        box-shadow: inset 0 2px 4px rgba(0,0,0,0.2), 0 0 0 2px rgba(79, 193, 255, 0.2);
    }

    /* Compact terminal for smaller spaces */
    .terminal.compact {
        height: 300px !important;
        max-height: 300px !important;
        min-height: 250px;
        font-size: 12px;
    }

    /* Custom scrollbar for terminals */
    .terminal::-webkit-scrollbar {
        width: 10px;
        height: 10px;
    }

    .terminal::-webkit-scrollbar-track {
        background: #2d2d2d;
        border-radius: 6px;
    }

    .terminal::-webkit-scrollbar-thumb {
        background: #555;
        border-radius: 6px;
        border: 1px solid #2d2d2d;
    }

    .terminal::-webkit-scrollbar-thumb:hover {
        background: #777;
    }

    .terminal::-webkit-scrollbar-corner {
        background: #2d2d2d;
    }

    /* Terminal content styling */
    .terminal .timestamp {
        color: #569cd6;
        font-weight: 600;
        user-select: none;
    }

    .terminal .info {
        color: #d4d4d4;
    }

    .terminal .success {
        color: #4ec9b0;
        font-weight: 500;
    }

    .terminal .warning {
        color: #dcdcaa;
        font-weight: 500;
    }

    .terminal .error {
        color: #f44747;
        font-weight: 500;
    }

    .terminal .progress {
        color: #4fc1ff;
        font-weight: 500;
    }

    .terminal .debug {
        color: #808080;
        font-style: italic;
    }

    /* Remove terminal-line styling as we're using textarea now */
    /* Auto-scroll indicator */
    .terminal.auto-scrolling::after {
        content: "üìç Auto-scrolling";
        position: absolute;
        bottom: 5px;
        right: 15px;
        background: rgba(0,0,0,0.7);
        color: #4fc1ff;
        padding: 2px 6px;
        border-radius: 10px;
        font-size: 10px;
        pointer-events: none;
        z-index: 10;
    }

    /* Terminal header enhancements */
    .terminal-header {
        background: linear-gradient(135deg, #343a40 0%, #495057 100%);
        color: white;
        border-radius: 6px 6px 0 0;
        padding: 8px 15px;
        border-bottom: 1px solid #333;
    }

    .terminal-controls {
        display: flex;
        gap: 5px;
    }

    .terminal-btn {
        background: none;
        border: 1px solid rgba(255,255,255,0.2);
        color: rgba(255,255,255,0.8);
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 11px;
        transition: all 0.2s ease;
    }

    .terminal-btn:hover {
        background: rgba(255,255,255,0.1);
        color: white;
        border-color: rgba(255,255,255,0.4);
    }

    /* Status indicators */
    .job-status-indicator {
        position: relative;
        padding: 5px 12px;
        border-radius: 15px;
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        border: 1px solid transparent;
        display: inline-flex;
        align-items: center;
        gap: 5px;
    }

    .job-status-indicator::before {
        content: "";
        width: 6px;
        height: 6px;
        border-radius: 50%;
        display: inline-block;
    }

    .job-status-indicator.pending {
        background: #e9ecef;
        color: #495057;
        border-color: #dee2e6;
    }

    .job-status-indicator.pending::before {
        background: #6c757d;
    }

    .job-status-indicator.running {
        background: #fff3cd;
        color: #856404;
        border-color: #ffeaa7;
        animation: pulse 2s infinite;
    }

    .job-status-indicator.running::before {
        background: #ffc107;
        animation: blink 1s infinite;
    }

    .job-status-indicator.completed {
        background: #d4edda;
        color: #155724;
        border-color: #c3e6cb;
    }

    .job-status-indicator.completed::before {
        background: #28a745;
    }

    .job-status-indicator.failed {
        background: #f8d7da;
        color: #721c24;
        border-color: #f5c6cb;
    }

    .job-status-indicator.failed::before {
        background: #dc3545;
    }

    @keyframes pulse {
        0% { box-shadow: 0 0 0 0 rgba(255, 193, 7, 0.4); }
        70% { box-shadow: 0 0 0 10px rgba(255, 193, 7, 0); }
        100% { box-shadow: 0 0 0 0 rgba(255, 193, 7, 0); }
    }

    @keyframes blink {
        0%, 50% { opacity: 1; }
        51%, 100% { opacity: 0.3; }
    }

    /* Card enhancements */
    .terminal-card {
        border: none;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        border-radius: 8px;
        overflow: hidden;
        height: fit-content;
    }

    .terminal-card .card-body {
        padding: 0 !important;
        overflow: hidden;
    }

    /* Scan statistics styling */
    .scan-stats {
        display: flex;
        gap: 15px;
        margin-bottom: 20px;
        flex-wrap: wrap;
    }

    .stat-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 15px;
        border-radius: 8px;
        text-align: center;
        min-width: 120px;
        flex: 1;
    }

    .stat-value {
        font-size: 24px;
        font-weight: bold;
        margin-bottom: 5px;
    }

    .stat-label {
        font-size: 12px;
        opacity: 0.9;
    }

    .progress-container {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
    }

    .form-section {
        margin-bottom: 25px;
        padding-bottom: 20px;
        border-bottom: 1px solid #dee2e6;
    }

    .form-section:last-child {
        border-bottom: none;
    }

    .form-section h6 {
        color: #495057;
        font-weight: 600;
        margin-bottom: 15px;
    }

    .pipeline-step {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 10px;
        transition: all 0.3s ease;
    }

    .pipeline-step.active {
        background: #e3f2fd;
        border-color: #2196f3;
    }

    .pipeline-step.completed {
        background: #e8f5e8;
        border-color: #4caf50;
    }

    .pipeline-step.error {
        background: #ffebee;
        border-color: #f44336;
    }

    .status-badge {
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 500;
    }

    .status-badge.pending {
        background: #e9ecef;
        color: #495057;
    }

    .status-badge.active {
        background: #e3f2fd;
        color: #1976d2;
    }

    .status-badge.completed {
        background: #e8f5e8;
        color: #388e3c;
    }

    .status-badge.error {
        background: #ffebee;
        color: #d32f2f;
    }

    .file-option {
        transition: all 0.2s ease;
        border-radius: 4px;
    }

    .file-option:hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .file-option.btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-color: #667eea;
    }

    #availableFiles {
        max-height: 200px;
        overflow-y: auto;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        padding: 8px;
        background: #f8f9fa;
    }

    /* Terminal resizer */
    .terminal-resizer {
        cursor: ns-resize;
        height: 4px;
        background: #dee2e6;
        transition: background 0.2s ease;
    }

    .terminal-resizer:hover {
        background: #007bff;
    }

    /* Responsive terminal sizing */
    @media (max-width: 768px) {
        .terminal {
            height: 300px;
            max-height: 300px;
            font-size: 11px;
        }

        .terminal.compact {
            height: 250px;
            max-height: 250px;
        }
    }

    @media (max-width: 576px) {
        .terminal {
            height: 250px;
            max-height: 250px;
            font-size: 10px;
            padding: 8px;
        }
    }

    /* Line numbers for debugging */
    .terminal.show-line-numbers .terminal-line::before {
        content: counter(line-counter);
        counter-increment: line-counter;
        color: #666;
        font-size: 10px;
        margin-right: 10px;
        min-width: 30px;
        display: inline-block;
        text-align: right;
        user-select: none;
    }

    .terminal.show-line-numbers {
        counter-reset: line-counter;
    }
</style>
{% endblock %}

{% block content %}
<!-- Header -->
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2><i class="bi bi-gear-wide-connected me-2"></i>Pipeline Management</h2>
        <p class="text-muted mb-0">Network discovery and data collection pipeline</p>
    </div>
    <div>
        <button class="btn btn-outline-secondary me-2" onclick="refreshStatus()">
            <i class="bi bi-arrow-clockwise"></i> Refresh
        </button>
        <button class="btn btn-outline-primary" onclick="viewLogs()">
            <i class="bi bi-journal-text"></i> View Logs
        </button>
    </div>
</div>

<!-- Navigation Tabs -->
<ul class="nav nav-tabs mb-4" id="pipelineTabs" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="scanner-tab" data-bs-toggle="tab" data-bs-target="#scanner" type="button" role="tab">
            <i class="bi bi-search me-2"></i>Network Scanner
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="collector-tab" data-bs-toggle="tab" data-bs-target="#collector" type="button" role="tab">
            <i class="bi bi-collection me-2"></i>Data Collection
        </button>
    </li>
<!--    <li class="nav-item" role="presentation">-->
<!--        <button class="nav-link" id="pipeline-tab" data-bs-toggle="tab" data-bs-target="#pipeline" type="button" role="tab">-->
<!--            <i class="bi bi-diagram-3 me-2"></i>Full Pipeline-->
<!--        </button>-->
<!--    </li>-->
</ul>

<!-- Tab Content -->
<div class="tab-content" id="pipelineTabContent">
    <!-- Network Scanner Tab -->
    <div class="tab-pane fade show active" id="scanner" role="tabpanel">
        <div class="row">
            <!-- Scanner Configuration -->
            <div class="col-lg-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-gear me-2"></i>Scanner Configuration</h5>
                    </div>
                    <div class="card-body">
                        <form id="scannerForm">
                            <!-- Network Target -->
                            <div class="form-section">
                                <h6><i class="bi bi-globe me-2"></i>Network Target</h6>
                                <div class="mb-3">
                                    <label for="target" class="form-label">Target Network/IP</label>
                                    <input type="text" class="form-control" id="target" value="10.76.0.0/16"
                                           placeholder="192.168.1.0/24 or 10.0.0.1">
                                    <div class="form-text">CIDR notation for networks or single IP addresses</div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <label for="timeout" class="form-label">Timeout</label>
                                        <select class="form-select" id="timeout">
                                            <option value="2s">2 seconds</option>
                                            <option value="4s" selected>4 seconds</option>
                                            <option value="6s">6 seconds</option>
                                            <option value="10s">10 seconds</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="concurrency" class="form-label">Concurrency</label>
                                        <input type="number" class="form-control" id="concurrency" value="80" min="10" max="200">
                                    </div>
                                </div>
                            </div>

                            <!-- SNMP Configuration -->
                            <div class="form-section">
                                <h6><i class="bi bi-shield-lock me-2"></i>SNMP Configuration</h6>
                                <div class="mb-3">
                                    <label for="communities" class="form-label">Communities</label>
                                    <input type="text" class="form-control" id="communities" value="public,write"
                                           placeholder="public,private,community1">
                                    <div class="form-text">Comma-separated list of SNMP communities</div>
                                </div>

                                <div class="mb-3">
                                    <label for="snmpVersion" class="form-label">SNMP Version</label>
                                    <select class="form-select" id="snmpVersion">
                                        <option value="2">SNMPv2c</option>
                                        <option value="3" selected>SNMPv3</option>
                                    </select>
                                </div>

                                <!-- SNMPv3 Configuration -->
                                <div id="snmpv3Config">
                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <label for="username" class="form-label">Username</label>
                                            <input type="text" class="form-control" id="username" value="">
                                        </div>
                                        <div class="col-md-6">
                                            <label for="authProtocol" class="form-label">Auth Protocol</label>
                                            <select class="form-select" id="authProtocol">
                                                <option value="MD5">MD5</option>
                                                <option value="SHA" selected>SHA</option>
                                                <option value="SHA224">SHA224</option>
                                                <option value="SHA256">SHA256</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <label for="authKey" class="form-label">Auth Key</label>
                                            <input type="password" class="form-control" id="authKey" value="">
                                        </div>
                                        <div class="col-md-6">
                                            <label for="privProtocol" class="form-label">Privacy Protocol</label>
                                            <select class="form-select" id="privProtocol">
                                                <option value="DES">DES</option>
                                                <option value="AES128" selected>AES128</option>
                                                <option value="AES192">AES192</option>
                                                <option value="AES256">AES256</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label for="privKey" class="form-label">Privacy Key</label>
                                        <input type="password" class="form-control" id="privKey" value="">
                                    </div>
                                </div>
                            </div>

                            <!-- Advanced Options -->
                            <div class="form-section">
                                <h6><i class="bi bi-sliders me-2"></i>Advanced Options</h6>
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label for="fingerprintType" class="form-label">Fingerprint Type</label>
                                        <select class="form-select" id="fingerprintType">
                                            <option value="basic">Basic</option>
                                            <option value="full" selected>Full</option>
                                            <option value="auto">Auto</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="outputFormat" class="form-label">Output Format</label>
                                        <select class="form-select" id="outputFormat">
                                            <option value="json">JSON</option>
                                            <option value="csv" selected>CSV</option>
                                            <option value="table">Table</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="outputFile" class="form-label">Output File</label>
                                    <input type="text" class="form-control" id="outputFile" value="site.csv" placeholder="output.csv">
                                </div>
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" id="enableDb" checked>
                                    <label class="form-check-label" for="enableDb">
                                        Enable Database Storage
                                    </label>
                                </div>
                                <div class="mb-3">
                                    <label for="database" class="form-label">Database File</label>
                                    <input type="text" class="form-control" id="database" value="./scanner_site_devices" placeholder="./scanner_devices">
                                </div>
                            </div>

                            <div class="d-grid gap-2">
                                <button type="submit" class="btn btn-primary btn-lg" id="startScanBtn">
                                    <i class="bi bi-play-fill me-2"></i>Start Network Scan
                                </button>
                                <button type="button" class="btn btn-outline-danger" id="stopScanBtn" style="display: none;">
                                    <i class="bi bi-stop-fill me-2"></i>Stop Scan
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Scanner Status and Output -->
            <div class="col-lg-6">
                <!-- Scan Statistics -->
                <div class="scan-stats" id="scanStats" style="display: none;">
                    <div class="stat-card">
                        <div class="stat-value" id="hostsScanned">0</div>
                        <div class="stat-label">Hosts Scanned</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="hostsFound">0</div>
                        <div class="stat-label">Responding</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="snmpReady">0</div>
                        <div class="stat-label">SNMP Ready</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="scanRate">0.0</div>
                        <div class="stat-label">Hosts/sec</div>
                    </div>
                </div>

                <!-- Progress Bar -->
                <div class="progress-container" id="progressContainer" style="display: none;">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span><strong>Scan Progress</strong></span>
                        <span id="progressText">0%</span>
                    </div>
                    <div class="progress mb-2">
                        <div class="progress-bar bg-success" role="progressbar" id="progressBar" style="width: 0%"></div>
                    </div>
                    <div class="row">
                        <div class="col-6">
                            <small class="text-muted">Elapsed: <span id="elapsedTime">00:00</span></small>
                        </div>
                        <div class="col-6 text-end">
                            <small class="text-muted">ETA: <span id="etaTime">--:--</span></small>
                        </div>
                    </div>
                </div>

                <!-- Scanner Terminal -->
                <div class="card terminal-card">
                    <div class="terminal-header d-flex justify-content-between align-items-center">
                        <h6 class="mb-0"><i class="bi bi-terminal me-2"></i>Scanner Output</h6>
                        <div class="d-flex align-items-center">
                            <div class="job-status-indicator pending me-3" id="scannerJobStatus">Ready</div>
                            <div class="terminal-controls">
                                <button class="terminal-btn" onclick="clearTerminal('scannerTerminal')">
                                    <i class="bi bi-trash"></i>
                                </button>
                                <button class="terminal-btn" onclick="downloadLog('scannerTerminal')">
                                    <i class="bi bi-download"></i>
                                </button>
                                <button class="terminal-btn" onclick="toggleAutoScroll('scannerTerminal')">
                                    <i class="bi bi-arrow-down"></i>
                                </button>
                                <button class="terminal-btn" onclick="resizeTerminal('scannerTerminal')">
                                    <i class="bi bi-arrows-expand"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    <textarea class="terminal auto-scrolling compact" id="scannerTerminal" rows="40" readonly>
[Ready]
</textarea>
                    <div class="terminal-resizer" onmousedown="startResize(event, 'scannerTerminal')"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Data Collection Tab -->
    <div class="tab-pane fade" id="collector" role="tabpanel">
        <div class="row">
            <div class="col-lg-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-collection me-2"></i>Data Collection Configuration</h5>
                    </div>
                    <div class="card-body">
                        <form id="collectorForm">
                            <div class="form-section">
                                <h6><i class="bi bi-file-earmark-data me-2"></i>Data Source</h6>
                                <div class="mb-3">
                                    <label for="scanFile" class="form-label">Scanner Database File</label>
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="scanFile" value="" placeholder="Select a JSON database file">
                                        <button class="btn btn-outline-secondary" type="button" onclick="selectScanFile()">
                                            <i class="bi bi-folder2-open"></i>
                                        </button>
                                        <button class="btn btn-outline-info" type="button" onclick="refreshScanFiles()">
                                            <i class="bi bi-arrow-clockwise"></i>
                                        </button>
                                    </div>
                                    <div class="form-text">JSON database file from network scanner (not the CSV output)</div>
                                    <div class="mt-2">
                                        <small class="text-muted">Available files:</small>
                                        <div id="availableFiles" class="mt-1">
                                            <small class="text-muted">Click refresh to scan for JSON files</small>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="d-grid gap-2">
                                <button type="submit" class="btn btn-primary btn-lg" id="startCollectionBtn">
                                    <i class="bi bi-play-fill me-2"></i>Start Data Collection
                                </button>
                                <button type="button" class="btn btn-outline-danger" id="stopCollectionBtn" style="display: none;">
                                    <i class="bi bi-stop-fill me-2"></i>Stop Collection
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <div class="col-lg-6">
                <!-- Collection Terminal -->
                <div class="card terminal-card">
                    <div class="terminal-header d-flex justify-content-between align-items-center">
                        <h6 class="mb-0"><i class="bi bi-terminal me-2"></i>Collection Output</h6>
                        <div class="d-flex align-items-center">
                            <div class="job-status-indicator pending me-3" id="collectorJobStatus">Ready</div>
                            <div class="terminal-controls">
                                <button class="terminal-btn" onclick="clearTerminal('collectionTerminal')">
                                    <i class="bi bi-trash"></i>
                                </button>
                                <button class="terminal-btn" onclick="downloadLog('collectionTerminal')">
                                    <i class="bi bi-download"></i>
                                </button>
                                <button class="terminal-btn" onclick="toggleAutoScroll('collectionTerminal')">
                                    <i class="bi bi-arrow-down"></i>
                                </button>
                                <button class="terminal-btn" onclick="resizeTerminal('collectionTerminal')">
                                    <i class="bi bi-arrows-expand"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                                                <textarea rows="20" class="terminal auto-scrolling compact" id="collectionTerminal" readonly>
[Ready] NAPALM data collector ready. Select a scan file and configure collection settings.
</textarea>
                    <div class="terminal-resizer" onmousedown="startResize(event, 'collectionTerminal')"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Full Pipeline Tab -->
<!--    <div class="tab-pane fade" id="pipeline" role="tabpanel">-->
<!--        <div class="card">-->
<!--            <div class="card-header d-flex justify-content-between align-items-center">-->
<!--                <h5 class="mb-0"><i class="bi bi-diagram-3 me-2"></i>Full Pipeline Execution</h5>-->
<!--                <div class="job-status-indicator pending" id="pipelineJobStatus">Ready</div>-->
<!--            </div>-->
<!--            <div class="card-body">-->
<!--                &lt;!&ndash; Pipeline Steps &ndash;&gt;-->
<!--                <div class="row mb-4">-->
<!--                    <div class="col-12">-->
<!--                        <h6 class="mb-3">Pipeline Steps</h6>-->
<!--                        <div class="pipeline-step" id="step1">-->
<!--                            <div class="d-flex align-items-center">-->
<!--                                <div class="me-3">-->
<!--                                    <i class="bi bi-1-circle fs-4"></i>-->
<!--                                </div>-->
<!--                                <div class="flex-grow-1">-->
<!--                                    <h6 class="mb-1">Network Discovery</h6>-->
<!--                                    <p class="mb-0 text-muted">SNMP scanning and device fingerprinting</p>-->
<!--                                </div>-->
<!--                                <div>-->
<!--                                    <span class="status-badge pending" id="step1Status">Pending</span>-->
<!--                                </div>-->
<!--                            </div>-->
<!--                        </div>-->

<!--                        <div class="pipeline-step" id="step2">-->
<!--                            <div class="d-flex align-items-center">-->
<!--                                <div class="me-3">-->
<!--                                    <i class="bi bi-2-circle fs-4"></i>-->
<!--                                </div>-->
<!--                                <div class="flex-grow-1">-->
<!--                                    <h6 class="mb-1">Data Collection</h6>-->
<!--                                    <p class="mb-0 text-muted">NAPALM-based configuration and inventory collection</p>-->
<!--                                </div>-->
<!--                                <div>-->
<!--                                    <span class="status-badge pending" id="step2Status">Pending</span>-->
<!--                                </div>-->
<!--                            </div>-->
<!--                        </div>-->

<!--                        <div class="pipeline-step" id="step3">-->
<!--                            <div class="d-flex align-items-center">-->
<!--                                <div class="me-3">-->
<!--                                    <i class="bi bi-3-circle fs-4"></i>-->
<!--                                </div>-->
<!--                                <div class="flex-grow-1">-->
<!--                                    <h6 class="mb-1">Database Import</h6>-->
<!--                                    <p class="mb-0 text-muted">Import collected data into CMDB</p>-->
<!--                                </div>-->
<!--                                <div>-->
<!--                                    <span class="status-badge pending" id="step3Status">Pending</span>-->
<!--                                </div>-->
<!--                            </div>-->
<!--                        </div>-->

<!--                        <div class="pipeline-step" id="step4">-->
<!--                            <div class="d-flex align-items-center">-->
<!--                                <div class="me-3">-->
<!--                                    <i class="bi bi-4-circle fs-4"></i>-->
<!--                                </div>-->
<!--                                <div class="flex-grow-1">-->
<!--                                    <h6 class="mb-1">Analysis & Reporting</h6>-->
<!--                                    <p class="mb-0 text-muted">Generate reports and update dashboards</p>-->
<!--                                </div>-->
<!--                                <div>-->
<!--                                    <span class="status-badge pending" id="step4Status">Pending</span>-->
<!--                                </div>-->
<!--                            </div>-->
<!--                        </div>-->
<!--                    </div>-->
<!--                </div>-->

<!--                &lt;!&ndash; Pipeline Controls &ndash;&gt;-->
<!--                <div class="row">-->
<!--                    <div class="col-md-8">-->
<!--                        <div class="mb-3">-->
<!--                            <label for="pipelineTarget" class="form-label">Target Network</label>-->
<!--                            <input type="text" class="form-control" id="pipelineTarget" value="10.76.0.0/16" placeholder="Enter network range">-->
<!--                        </div>-->
<!--                    </div>-->
<!--                    <div class="col-md-4">-->
<!--                        <div class="d-grid gap-2">-->
<!--                            <button class="btn btn-primary btn-lg" id="startPipelineBtn">-->
<!--                                <i class="bi bi-play-fill me-2"></i>Start Full Pipeline-->
<!--                            </button>-->
<!--                            <button class="btn btn-outline-danger" id="stopPipelineBtn" style="display: none;">-->
<!--                                <i class="bi bi-stop-fill me-2"></i>Stop Pipeline-->
<!--                            </button>-->
<!--                        </div>-->
<!--                    </div>-->
<!--                </div>-->

<!--                &lt;!&ndash; Pipeline Output &ndash;&gt;-->
<!--                <div class="row mt-4">-->
<!--                    <div class="col-12">-->
<!--                        <div class="card terminal-card">-->
<!--                            <div class="terminal-header d-flex justify-content-between align-items-center">-->
<!--                                <h6 class="mb-0"><i class="bi bi-terminal me-2"></i>Pipeline Output</h6>-->
<!--                                <div class="terminal-controls">-->
<!--                                    <button class="terminal-btn" onclick="clearTerminal('pipelineTerminal')">-->
<!--                                        <i class="bi bi-trash"></i>-->
<!--                                    </button>-->
<!--                                    <button class="terminal-btn" onclick="downloadLog('pipelineTerminal')">-->
<!--                                        <i class="bi bi-download"></i>-->
<!--                                    </button>-->
<!--                                    <button class="terminal-btn" onclick="toggleAutoScroll('pipelineTerminal')">-->
<!--                                        <i class="bi bi-arrow-down"></i>-->
<!--                                    </button>-->
<!--                                    <button class="terminal-btn" onclick="resizeTerminal('pipelineTerminal')">-->
<!--                                        <i class="bi bi-arrows-expand"></i>-->
<!--                                    </button>-->
<!--                                </div>-->
<!--                            </div>-->
<!--                            <textarea class="terminal auto-scrolling" id="pipelineTerminal" rows="20" readonly>-->
<!--[Ready] Full pipeline ready. This will execute network discovery, data collection, and database import in sequence.-->
<!--</textarea>-->
<!--                            <div class="terminal-resizer" onmousedown="startResize(event, 'pipelineTerminal')"></div>-->
<!--                        </div>-->
<!--                    </div>-->
<!--                </div>-->
<!--            </div>-->
<!--        </div>-->
<!--    </div>-->
</div>
{% endblock %}

{% block scripts %}
<!-- Socket.IO for real-time updates -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>

<script>
    // Global variables
    let socket = null;
    let scanStartTime = null;
    let collectionStartTime = null;
    let pipelineStartTime = null;
    let currentJobs = {
        scanner: null,
        collector: null,
        pipeline: null
    };

    // Terminal management
    let autoScrollEnabled = {
        scannerTerminal: true,
        collectionTerminal: true,
        pipelineTerminal: true
    };

    let lineNumbers = false;
    let resizing = false;

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
        initializeSocketIO();
        setupEventListeners();
        updateCommandPreview();
        refreshScanFiles(); // Auto-load available files on page load
    });

    // Socket.IO initialization
    function initializeSocketIO() {
        socket = io();

        socket.on('connect', function() {
            addToTerminal('scannerTerminal', 'Connected to server', 'success');
        });

        socket.on('disconnect', function() {
            addToTerminal('scannerTerminal', 'Disconnected from server', 'error');
        });

        // Scanner events
        socket.on('scanner_output', function(data) {
            addToTerminal('scannerTerminal', data.message, data.type);
        });

        socket.on('scanner_progress', function(data) {
            updateScanProgress(data);
        });

        socket.on('scanner_complete', function(data) {
            onScanComplete(data);
        });

        socket.on('scanner_error', function(data) {
            addToTerminal('scannerTerminal', 'Error: ' + data.message, 'error');
            setJobStatus('scannerJobStatus', 'failed', 'Scan failed: ' + data.message);
            resetScanForm();
        });

        // Collection events
        socket.on('collection_output', function(data) {
            addToTerminal('collectionTerminal', data.message, data.type);
        });

        socket.on('collection_progress', function(data) {
            updateCollectionProgress(data);
        });

        socket.on('collection_complete', function(data) {
            onCollectionComplete(data);
        });

        socket.on('collection_error', function(data) {
            addToTerminal('collectionTerminal', 'Error: ' + data.message, 'error');
            setJobStatus('collectorJobStatus', 'failed', 'Collection failed: ' + data.message);
            resetCollectionForm();
        });

        // Pipeline events
        socket.on('pipeline_step', function(data) {
            updatePipelineStep(data.step, data.status, data.message);
        });

        socket.on('pipeline_complete', function(data) {
            onPipelineComplete(data);
        });

        socket.on('pipeline_error', function(data) {
            addToTerminal('pipelineTerminal', 'Error: ' + data.message, 'error');
            setJobStatus('pipelineJobStatus', 'failed', 'Pipeline failed: ' + data.message);
            resetPipelineForm();
        });

        // File discovery events
        socket.on('scan_files_list', function(data) {
            updateAvailableFiles(data.files);
        });

        socket.on('scan_files_error', function(data) {
            document.getElementById('availableFiles').innerHTML =
                '<small class="text-danger">Error loading files: ' + data.message + '</small>';
        });
    }

    // Terminal management functions - Textarea Version
    function addToTerminal(terminalId, message, type = 'info') {
        const terminal = document.getElementById(terminalId);
        if (!terminal) return;

        const timestamp = new Date().toLocaleTimeString();
        const line = `[${timestamp}] ${message}`;

        // Add new line to textarea content
        if (terminal.value) {
            terminal.value += '\n' + line;
        } else {
            terminal.value = line;
        }

        // Limit lines to prevent memory issues
        const lines = terminal.value.split('\n');
        if (lines.length > 500) {
            terminal.value = lines.slice(-500).join('\n');
        }

        // Auto-scroll to bottom if enabled
        if (autoScrollEnabled[terminalId]) {
            terminal.scrollTop = terminal.scrollHeight;
        }
    }

    function clearTerminal(terminalId) {
        const terminal = document.getElementById(terminalId);
        if (terminal) {
            terminal.value = '';
            terminal.scrollTop = 0;

            // Ensure auto-scroll remains enabled if it was enabled
            if (autoScrollEnabled[terminalId]) {
                terminal.classList.add('auto-scrolling');
            }

            console.log(`Terminal ${terminalId} cleared. Auto-scroll enabled: ${autoScrollEnabled[terminalId]}`);
        }
    }

    function toggleAutoScroll(terminalId) {
        autoScrollEnabled[terminalId] = !autoScrollEnabled[terminalId];
        const terminal = document.getElementById(terminalId);

        if (autoScrollEnabled[terminalId]) {
            terminal.classList.add('auto-scrolling');
            // Force immediate scroll to bottom
            terminal.scrollTop = terminal.scrollHeight;
        } else {
            terminal.classList.remove('auto-scrolling');
        }

        console.log(`Auto-scroll ${autoScrollEnabled[terminalId] ? 'enabled' : 'disabled'} for ${terminalId}`);
        console.log(`Terminal scrollHeight: ${terminal.scrollHeight}, scrollTop: ${terminal.scrollTop}, clientHeight: ${terminal.clientHeight}`);
    }

    function downloadLog(terminalId) {
        const terminal = document.getElementById(terminalId);
        const content = terminal.value;

        const blob = new Blob([content], { type: 'text/plain' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${terminalId}_log.txt`;
        a.click();
        window.URL.revokeObjectURL(url);
    }

    function resizeTerminal(terminalId) {
        const terminal = document.getElementById(terminalId);
        const currentHeight = parseInt(window.getComputedStyle(terminal).height, 10);

        // Toggle between normal and expanded
        if (currentHeight <= 400) {
            terminal.style.height = '600px';
            terminal.style.maxHeight = '600px';
        } else {
            terminal.style.height = '400px';
            terminal.style.maxHeight = '400px';
        }
    }

    // Terminal resizing
    function startResize(event, terminalId) {
        resizing = true;
        const terminal = document.getElementById(terminalId);
        const startY = event.clientY;
        const startHeight = parseInt(document.defaultView.getComputedStyle(terminal).height, 10);

        function doResize(e) {
            if (!resizing) return;
            const newHeight = startHeight + e.clientY - startY;
            if (newHeight >= 200 && newHeight <= 800) {
                terminal.style.height = newHeight + 'px';
                terminal.style.maxHeight = newHeight + 'px';
            }
        }

        function stopResize() {
            resizing = false;
            document.removeEventListener('mousemove', doResize);
            document.removeEventListener('mouseup', stopResize);
        }

        document.addEventListener('mousemove', doResize);
        document.addEventListener('mouseup', stopResize);
    }

    // File management functions
    function updateAvailableFiles(files) {
        const container = document.getElementById('availableFiles');

        if (!files || files.length === 0) {
            container.innerHTML = '<small class="text-muted">No JSON database files found</small>';
            return;
        }

        let html = '';
        files.forEach(file => {
            const fileInfo = file.split('|'); // filename|size|modified
            const filename = fileInfo[0];
            const fileSize = fileInfo[1] || '';
            const fileDate = fileInfo[2] || '';
            const isUnvalidated = fileInfo[3] === '[unvalidated]';

            const buttonClass = isUnvalidated ? 'btn-outline-warning' : 'btn-outline-secondary';
            const icon = isUnvalidated ? 'bi-exclamation-triangle' : 'bi-file-earmark-code';

            html += `
                <div class="d-flex align-items-center justify-content-between mb-1">
                    <button type="button" class="btn btn-sm ${buttonClass} file-option me-2"
                            data-filename="${filename}" onclick="selectFileFromList('${filename}')">
                        <i class="bi ${icon} me-1"></i>${filename}
                        ${isUnvalidated ? ' <small>(unvalidated)</small>' : ''}
                    </button>
                    <small class="text-muted">${fileSize} ${fileDate}</small>
                </div>
            `;
        });

        container.innerHTML = html;

        // Auto-select the first file if none is selected
        const currentFile = document.getElementById('scanFile').value;
        if (!currentFile && files.length > 0) {
            selectFileFromList(files[0].split('|')[0]);
        }
    }

    function selectFileFromList(filename) {
        document.getElementById('scanFile').value = filename;
        // Update the visual selection
        const fileButtons = document.querySelectorAll('.file-option');
        fileButtons.forEach(btn => btn.classList.remove('btn-primary'));
        fileButtons.forEach(btn => btn.classList.add('btn-outline-secondary'));

        const selectedBtn = document.querySelector(`[data-filename="${filename}"]`);
        if (selectedBtn) {
            selectedBtn.classList.remove('btn-outline-secondary');
            selectedBtn.classList.add('btn-primary');
        }
    }

    function selectScanFile() {
        // Get available files and show selection
        socket.emit('get_scan_files');
    }

    function refreshScanFiles() {
        // Request list of available JSON scan files
        socket.emit('get_scan_files');
    }

    // Event listeners
    function setupEventListeners() {
        // Scanner form
        document.getElementById('scannerForm').addEventListener('submit', startScan);
        document.getElementById('stopScanBtn').addEventListener('click', stopScan);

        // Collection form
        document.getElementById('collectorForm').addEventListener('submit', startCollection);
        document.getElementById('stopCollectionBtn').addEventListener('click', stopCollection);

        // Pipeline form
        document.getElementById('startPipelineBtn').addEventListener('click', startPipeline);
        document.getElementById('stopPipelineBtn').addEventListener('click', stopPipeline);

        // SNMP version change
        document.getElementById('snmpVersion').addEventListener('change', function() {
            const snmpv3Config = document.getElementById('snmpv3Config');
            snmpv3Config.style.display = this.value === '3' ? 'block' : 'none';
            updateCommandPreview();
        });

        // Update command preview on input changes
        ['target', 'timeout', 'concurrency', 'communities', 'username', 'authProtocol', 'authKey', 'privProtocol', 'privKey', 'fingerprintType', 'outputFormat', 'outputFile', 'database'].forEach(id => {
            const element = document.getElementById(id);
            if (element) {
                element.addEventListener('input', updateCommandPreview);
            }
        });
    }

    // Job status management
    function setJobStatus(statusElementId, status, message = '') {
        const statusElement = document.getElementById(statusElementId);
        if (statusElement) {
            statusElement.className = 'job-status-indicator ' + status + (statusElementId.includes('Job') ? ' me-3' : '');
            switch(status) {
                case 'running':
                    statusElement.textContent = 'Running';
                    break;
                case 'completed':
                    statusElement.textContent = 'Completed';
                    break;
                case 'failed':
                    statusElement.textContent = 'Failed';
                    break;
                default:
                    statusElement.textContent = 'Ready';
            }

            if (message) {
                statusElement.title = message;
            }
        }
    }

    // Scanner functions
    function startScan(e) {
        e.preventDefault();

        const formData = getFormData('scannerForm');

        // Validate required fields
        if (!formData.target.trim()) {
            alert('Please enter a target network or IP address');
            return;
        }

        // Set job status to running
        setJobStatus('scannerJobStatus', 'running', 'Network scan in progress');

        // Show UI elements
        document.getElementById('scanStats').style.display = 'block';
        document.getElementById('progressContainer').style.display = 'block';
        document.getElementById('startScanBtn').style.display = 'none';
        document.getElementById('stopScanBtn').style.display = 'block';

        // Reset counters
        document.getElementById('hostsScanned').textContent = '0';
        document.getElementById('hostsFound').textContent = '0';
        document.getElementById('snmpReady').textContent = '0';
        document.getElementById('scanRate').textContent = '0.0';

        scanStartTime = new Date();

        // Clear terminal and ensure auto-scroll is enabled
        clearTerminal('scannerTerminal');
        autoScrollEnabled['scannerTerminal'] = true;
        const terminal = document.getElementById('scannerTerminal');
        if (terminal) {
            terminal.classList.add('auto-scrolling');
        }

        addToTerminal('scannerTerminal', 'Starting network scan...', 'info');
        addToTerminal('scannerTerminal', 'Target: ' + formData.target, 'info');

        // Debug terminal state
        setTimeout(() => debugTerminal('scannerTerminal'), 100);

        // Send to server
        socket.emit('start_scan', formData);
    }

    function stopScan() {
        socket.emit('stop_scan');
        setJobStatus('scannerJobStatus', 'pending', 'Scan stopped by user');
        resetScanForm();
    }

    function resetScanForm() {
        document.getElementById('scanStats').style.display = 'none';
        document.getElementById('progressContainer').style.display = 'none';
        document.getElementById('startScanBtn').style.display = 'block';
        document.getElementById('stopScanBtn').style.display = 'none';
    }

    function onScanComplete(data) {
        setJobStatus('scannerJobStatus', 'completed', `Scan completed. Found ${data.found} devices, ${data.snmp_ready} SNMP ready`);
        addToTerminal('scannerTerminal', `Scan completed successfully! Found ${data.found} responding devices, ${data.snmp_ready} SNMP ready.`, 'success');
        addToTerminal('scannerTerminal', `Output saved to: ${data.output_file}`, 'info');
        resetScanForm();
    }

    // Collection functions
    function startCollection(e) {
        e.preventDefault();
        setJobStatus('collectorJobStatus', 'running', 'Data collection in progress');

        document.getElementById('startCollectionBtn').style.display = 'none';
        document.getElementById('stopCollectionBtn').style.display = 'block';

        const formData = {
            scan_file: document.getElementById('scanFile').value,
            max_workers: 10,
            timeout: 60
        };

        addToTerminal('collectionTerminal', 'Starting NAPALM data collection...', 'info');
        socket.emit('start_collection', formData);
    }

    function stopCollection() {
        socket.emit('stop_collection');
        setJobStatus('collectorJobStatus', 'pending', 'Collection stopped by user');
        resetCollectionForm();
    }

    function resetCollectionForm() {
        document.getElementById('startCollectionBtn').style.display = 'block';
        document.getElementById('stopCollectionBtn').style.display = 'none';
    }

    function onCollectionComplete(data) {
        setJobStatus('collectorJobStatus', 'completed', `Collection completed. Processed ${data.processed} devices`);
        addToTerminal('collectionTerminal', `Collection completed! Processed ${data.processed} devices successfully.`, 'success');
        resetCollectionForm();
    }

    // Pipeline functions
    function startPipeline() {
        const target = document.getElementById('pipelineTarget').value;
        if (!target.trim()) {
            alert('Please enter a target network');
            return;
        }

        setJobStatus('pipelineJobStatus', 'running', 'Full pipeline execution in progress');

        document.getElementById('startPipelineBtn').style.display = 'none';
        document.getElementById('stopPipelineBtn').style.display = 'block';

        const formData = { target: target };
        addToTerminal('pipelineTerminal', 'Starting full pipeline execution...', 'info');
        socket.emit('start_pipeline', formData);
    }

    function stopPipeline() {
        socket.emit('stop_pipeline');
        setJobStatus('pipelineJobStatus', 'pending', 'Pipeline stopped by user');
        resetPipelineForm();
    }

    function resetPipelineForm() {
        document.getElementById('startPipelineBtn').style.display = 'block';
        document.getElementById('stopPipelineBtn').style.display = 'none';

        // Reset all step statuses
        for (let i = 1; i <= 4; i++) {
            updatePipelineStepStatus(i, 'pending');
        }
    }

    function onPipelineComplete(data) {
        setJobStatus('pipelineJobStatus', 'completed', `Pipeline completed in ${data.total_time} seconds`);
        addToTerminal('pipelineTerminal', `Pipeline execution completed successfully in ${data.total_time} seconds!`, 'success');
        resetPipelineForm();
    }

    // Helper functions
    function getFormData(formId) {
        const data = {};
        data.target = document.getElementById('target').value;
        data.timeout = document.getElementById('timeout').value;
        data.concurrency = parseInt(document.getElementById('concurrency').value);
        data.communities = document.getElementById('communities').value;
        data.snmpVersion = document.getElementById('snmpVersion').value;
        data.username = document.getElementById('username').value;
        data.authProtocol = document.getElementById('authProtocol').value;
        data.authKey = document.getElementById('authKey').value;
        data.privProtocol = document.getElementById('privProtocol').value;
        data.privKey = document.getElementById('privKey').value;
        data.fingerprintType = document.getElementById('fingerprintType').value;
        data.outputFormat = document.getElementById('outputFormat').value;
        data.outputFile = document.getElementById('outputFile').value;
        data.database = document.getElementById('database').value;
        data.enableDb = document.getElementById('enableDb').checked;
        return data;
    }

    function updateCommandPreview() {
        const formData = getFormData('scannerForm');
        let command = 'gosnmpcli -mode scan';
        command += ` -target ${formData.target}`;
        command += ` -timeout ${formData.timeout}`;
        command += ` -concurrency ${formData.concurrency}`;
        command += ` -communities "${formData.communities}"`;

        if (formData.snmpVersion === '3') {
            command += ` -snmp-version 3`;
            command += ` -username "${formData.username}"`;
            command += ` -auth-protocol ${formData.authProtocol}`;
            command += ` -auth-key "${formData.authKey}"`;
            command += ` -priv-protocol ${formData.privProtocol}`;
            command += ` -priv-key "${formData.privKey}"`;
        }

        command += ` -fingerprint-type ${formData.fingerprintType}`;
        if (formData.enableDb) {
            command += ` -enable-db -database "${formData.database}"`;
        }
        command += ` -output-file ${formData.outputFile} -output ${formData.outputFormat}`;

        const previewElement = document.getElementById('commandPreview');
        if (previewElement) {
            previewElement.textContent = command;
        }
    }

    function updateScanProgress(data) {
        document.getElementById('hostsScanned').textContent = data.scanned || 0;
        document.getElementById('hostsFound').textContent = data.found || 0;
        document.getElementById('snmpReady').textContent = data.snmp_ready || 0;
        document.getElementById('scanRate').textContent = (data.rate || 0).toFixed(1);

        // Update progress bar
        if (data.total > 0) {
            const percentage = Math.round((data.scanned / data.total) * 100);
            document.getElementById('progressBar').style.width = percentage + '%';
            document.getElementById('progressText').textContent = percentage + '%';
        }

        // Update elapsed time
        if (scanStartTime) {
            const elapsed = Math.floor((new Date() - scanStartTime) / 1000);
            const minutes = Math.floor(elapsed / 60);
            const seconds = elapsed % 60;
            document.getElementById('elapsedTime').textContent =
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }
    }

    function updateCollectionProgress(data) {
        // Similar implementation for collection progress
    }

    function updatePipelineStep(step, status, message) {
        updatePipelineStepStatus(step, status);
        if (message) {
            addToTerminal('pipelineTerminal', `Step ${step}: ${message}`, status === 'error' ? 'error' : 'info');
        }
    }

    function updatePipelineStepStatus(step, status) {
        const stepElement = document.getElementById(`step${step}`);
        const statusElement = document.getElementById(`step${step}Status`);

        if (stepElement && statusElement) {
            // Update step container class
            stepElement.className = 'pipeline-step ' + status;

            // Update status badge
            statusElement.className = 'status-badge ' + status;
            statusElement.textContent = status.charAt(0).toUpperCase() + status.slice(1);
        }
    }

    // Utility functions
    function refreshStatus() {
        socket.emit('get_status');
    }

    function viewLogs() {
        window.open('{{ url_for("pipeline.logs") }}', '_blank');
    }

    // Debug function to check terminal state
    function debugTerminal(terminalId) {
        const terminal = document.getElementById(terminalId);
        if (terminal) {
            console.log(`=== DEBUG ${terminalId} ===`);
            console.log('Element type:', terminal.tagName);
            console.log('Element height:', terminal.style.height);
            console.log('Computed height:', window.getComputedStyle(terminal).height);
            console.log('Computed max-height:', window.getComputedStyle(terminal).maxHeight);
            console.log('Computed overflow-y:', window.getComputedStyle(terminal).overflowY);
            console.log('scrollHeight:', terminal.scrollHeight);
            console.log('scrollTop:', terminal.scrollTop);
            console.log('clientHeight:', terminal.clientHeight);
            console.log('Content lines:', terminal.value.split('\n').length);
            console.log('Auto-scroll enabled:', autoScrollEnabled[terminalId]);
            console.log('Has auto-scrolling class:', terminal.classList.contains('auto-scrolling'));
            console.log('========================');
        }
    }

    // Make debug function available globally
    window.debugTerminal = debugTerminal;
</script>
{% endblock %}